jQuery(document).ready(function(r){var i,o,e;r(document.body).on("click","#fmwp-topic-popup-preview-action",function(){var p=r(this).parents("#fmwp-topic-popup-editors");p.hasClass("fmwp-topic-popup-preview-hidden")?(p.removeClass("fmwp-topic-popup-preview-hidden"),r(this).html(r(this).data("hide_label")),r("#fmwptopiccontent-preview").html(r("#fmwptopiccontent").val())):(p.addClass("fmwp-topic-popup-preview-hidden"),r(this).html(r(this).data("show_label"))),fmwp_resize_popup()}),r(document.body).on("click",".fmwp-topic-popup-discard",function(){var t;fmwp_is_busy("topic_popup")||(t=r(this).parents("#fmwp-topic-popup-wrapper")).hide(1,function(){t.find("form")[0].reset(),r("#fmwptopiccontent").val(""),r("#fmwptopiccontent-preview").html(""),t.removeClass("fmwp-fullsize");var p=t.find("#fmwp-topic-popup-preview-action");p.html(p.data("hide_label")),t.find("#fmwp-topic-popup-editors").removeClass("fmwp-topic-popup-preview-hidden")})}),r(document.body).on("click",".fmwp-topic-popup-submit",function(p){var s,n,t,i,o,a,c,f;p.preventDefault(),fmwp_is_busy("topic_popup")||((s=r(this)).siblings(".fmwp-ajax-loading").css("visibility","visible").show(),s.css("visibility","hidden"),n=r("#fmwp-topic-popup-wrapper"),p=r(this).parents("form"),t=p.serializeArray(),i=tinyMCE.get("fmwptopiccontent"),o={},r.each(t,function(p){"fmwp-topic[content]"===t[p].name?o[t[p].name]=i.getContent({format:"raw"}):o[t[p].name]=t[p].value}),a=o["fmwp-topic[forum_id]"],c=o["fmwp-topic[topic_id]"],f="edit-topic"===o["fmwp-action"]?"fmwp_edit_topic":"fmwp_create_topic",p.find("input, #wp-fmwptopiccontent-wrap").removeClass("fmwp-error-field").removeAttr("title"),fmwp_set_busy("topic_popup",!0),wp.ajax.send(f,{data:o,success:function(p){"fmwp_edit_topic"==f?(i=n.data("fmwp-target"),e=p,o=c,"forum-page"===(i=i)||"topics-page"===i?(t=wp.template("fmwp-topic")(e),r(".fmwp-topics-wrapper").find('.fmwp-topic-row[data-topic_id="'+o+'"]').replaceWith(t)):"topic-page"===i&&(r(".fmwp-topic-title").html(e.title),r(".fmwp-topic-data-content").html(e.content),r(".fmwp-topic-stats.fmwp-tags-stats").length&&(o=wp.template("fmwp-topic-tags-line")(e.tags),r(".fmwp-topic-stats.fmwp-tags-stats").html(o)),wp.hooks.doAction("fmwp_after_edit_topic",e))):(t=p,i=a,t=wp.template("fmwp-topic")(t),"date_desc"===(o=(i=(i=r('.fmwp-topics-wrapper[data-fmwp_forum_id="'+i+'"]')).length?i:r(".fmwp-archive-topics-wrapper .fmwp-topics-wrapper")).data("order"))?i.find(".fmwp-topic-row.fmwp-topic-announcement:last").length?i.find(".fmwp-topic-row.fmwp-topic-announcement:last").after(t):i.find(".fmwp-topic-row.fmwp-topic-pinned:last").length?i.find(".fmwp-topic-row.fmwp-topic-pinned:last").after(t):i.find(".fmwp-topic-row.fmwp-topic-global:last").length?i.find(".fmwp-topic-row.fmwp-topic-global:last").after(t):i.prepend(t):"date_asc"===o&&i.append(t),i.find(".fmwp-forum-no-topics").length&&i.find(".fmwp-forum-no-topics").remove(),i.find(".fmwp-topic-actions-dropdown").length?i.siblings(".fmwp-topics-wrapper-heading").removeClass("fmwp-no-actions-heading"):i.siblings(".fmwp-topics-wrapper-heading").addClass("fmwp-no-actions-heading")),fmwp_set_busy("topic_popup",!1),r(".fmwp-topic-popup-discard:first").trigger("click"),s.siblings(".fmwp-ajax-loading").css("visibility","hidden"),s.css("visibility","visible");var t,i,o,e=r('.fmwp-forum-head[data-fmwp_forum_id="'+a+'"]');(e.length?e.find(".fmwp-forum-sort"):r(".fmwp-archive-topics-wrapper").find(".fmwp-topics-sort")).trigger("change")},error:function(t){t.errors?r.each(t.errors,function(p){jQuery("#"+t.errors[p].field).addClass("fmwp-error-field").attr("title",t.errors[p].message)}):(console.log(t),r(this).fmwp_notice({message:t,type:"error"})),fmwp_set_busy("topic_popup",!1),s.siblings(".fmwp-ajax-loading").css("visibility","hidden"),s.css("visibility","visible")}}))}),r(document.body).on("keyup","#fmwptopiccontent",(i=function(p){var t;r(this).parents("#fmwp-topic-popup-editors").hasClass("fmwp-topic-popup-preview-hidden")||fmwp_is_busy("topic_popup_preview")||(t=fmwp_stringToHash(this.value))!=r(this).data("content-hash")&&(r(this).data("content-hash",t),fmwp_set_busy("topic_popup_preview",!0),wp.ajax.send("fmwp_topic_build_preview",{data:{content:this.value,nonce:fmwp_front_data.nonce},success:function(p){r("#fmwptopiccontent-preview").html(p),fmwp_set_busy("topic_popup_preview",!1)},error:function(p){console.log(p),r(this).fmwp_notice({message:p,type:"error"}),fmwp_set_busy("topic_popup_preview",!1)}}))},o=1e3,e=0,function(){var p=this,t=arguments;clearTimeout(e),e=setTimeout(function(){i.apply(p,t)},o||0)}))});